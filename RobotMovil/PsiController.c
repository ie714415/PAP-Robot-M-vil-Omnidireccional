#include "PsiController.h"

/**Constant vector that store the rads of the function sin*/
const float psiSinVector[] = { 0, 0.0175, 0.0350, 0.0525, 0.0699, 0.0874, 0.1048, 0.1222, 0.1395, 0.1568, 0.1741, 0.1913,
							0.2085, 0.2255, 0.2426, 0.2595, 0.2764, 0.2931, 0.3098, 0.3264, 0.3429, 0.3593, 0.3756, 0.3917,
							0.4078, 0.4237, 0.4395, 0.4551, 0.4706, 0.4860, 0.5012, 0.5163, 0.5312, 0.5459, 0.5605, 0.5749,
							0.5891, 0.6032, 0.6171, 0.6307, 0.6442, 0.6575, 0.6706, 0.6835, 0.6961, 0.7086, 0.7208, 0.7328,
							0.7446, 0.7562, 0.7675, 0.7786, 0.7895, 0.8001, 0.8105, 0.8206, 0.8305, 0.8401, 0.8495, 0.8586,
							0.8674, 0.8760, 0.8843, 0.8923, 0.9001, 0.9076, 0.9148, 0.9217, 0.9284, 0.9347, 0.9408, 0.9466,
							0.9521, 0.9573, 0.9622, 0.9668, 0.9711, 0.9752, 0.9789, 0.9823, 0.9854, 0.9883, 0.9908, 0.9930,
							0.9949, 0.9965, 0.9978, 0.9988, 0.9995, 0.9999, 1, 0.9998, 0.9992, 0.9984, 0.9972, 0.9958,
							0.9940, 0.9920, 0.9896, 0.9870, 0.9840, 0.9807, 0.9771, 0.9733, 0.9691, 0.9646, 0.9599, 0.9548,
							0.9495, 0.9438, 0.9379, 0.9317, 0.9252, 0.9184, 0.9114, 0.9040, 0.8964, 0.8885, 0.8803, 0.8719, 
							0.8632, 0.8542, 0.8450, 0.8355, 0.8258, 0.8158, 0.8055, 0.7951, 0.7843, 0.7733, 0.7621, 0.7507, 
							0.7390, 0.7271, 0.7150, 0.7026, 0.6901, 0.6773, 0.6643, 0.6511, 0.6378, 0.6242, 0.6104, 0.5965,
							0.5823, 0.5680, 0.5535, 0.5389, 0.5240, 0.5091, 0.4939, 0.4786, 0.4632, 0.4476, 0.4319, 0.4160, 
							0.4001, 0.3840, 0.3678, 0.3514, 0.3350, 0.3184, 0.3018, 0.2851, 0.2683, 0.2514, 0.2344, 0.2173,
							0.2002, 0.1831, 0.1658, 0.1485, 0.1312, 0.1138, 0.0964, 0.0790, 0.0616, 0.0441, 0.0266, 0.0091,
							-0.0084, -0.0259, -0.0434, -0.0609, -0.0783, -0.0958, -0.1132, -0.1305, -0.1479, -0.1651, -0.1824, -0.1996, 
							-0.2167, -0.2337, -0.2507, -0.2676, -0.2844, -0.3012, -0.3178, -0.3343, -0.3508, -0.3671, -0.3833, -0.3994, 
							-0.4154, -0.4313, -0.4470, -0.4626, -0.4780, -0.4933, -0.5085, -0.5235, -0.5383, -0.5530, -0.5675, -0.5818, 
							-0.5959, -0.6099, -0.6237, -0.6372, -0.6506, -0.6638, -0.6768, -0.6896, -0.7021, -0.7145, -0.7266, -0.7385, 
							-0.7502, -0.7617, -0.7729, -0.7839, -0.7946, -0.8051, -0.8154, -0.8254, -0.8352, -0.8446, -0.8539, -0.8629, 
							-0.8716, -0.8800, -0.8882, -0.8961, -0.9037, -0.9111, -0.9182, -0.9250, -0.9315, -0.9377, -0.9436, -0.9493, 
							-0.9546, -0.9597, -0.9645, -0.9689, -0.9731, -0.9770, -0.9806, -0.9839, -0.9868, -0.9895, -0.9919, -0.9940, 
							-0.9957, -0.9972, -0.9984, -0.9992, -0.9997, -1, -0.9999, -0.9995, -0.9989, -0.9979, -0.9966, -0.9950, 
							-0.9931, -0.9909, -0.9884, -0.9856, -0.9825, -0.9790, -0.9753, -0.9713, -0.9670, -0.9624, -0.9575, -0.9523, 
							-0.9468, -0.9410, -0.9350, -0.9286, -0.9220, -0.9151, -0.9079, -0.9004, -0.8926, -0.8846, -0.8763, -0.8678, 
							-0.8589, -0.8498, -0.8405, -0.8309, -0.8210, -0.8109, -0.8005, -0.7899, -0.7791, -0.7680, -0.7567, -0.7451, 
							-0.7333, -0.7213, -0.7091, -0.6966, -0.6840, -0.6711, -0.6580, -0.6447, -0.6313, -0.6176, -0.6037, -0.5897, 
							-0.5755, -0.5611, -0.5465, -0.5318, -0.5169, -0.5018, -0.4866, -0.4712, -0.4557, -0.4401, -0.4243, -0.4084, 
							-0.3924, -0.3762, -0.3599, -0.3435, -0.3271, -0.3105, -0.2938, -0.2770, -0.2602, -0.2432, -0.2262, -0.2091, 
							-0.1920, -0.1748, -0.1575, -0.1402, -0.1229, -0.1055, -0.0881, -0.0706, -0.0532, -0.0357, -0.0182};

float psiSin(uint16_t time)
{
	uint16_t t;
	t = time % 360;
	return psiSinVector[t];
}

float psiCos(uint16_t time)
{
	return psiSin(time + 90);
}

//					 C1				   C2				 C3				   C4
//  		|cos(psi)+sin(psi) cos(psi)-sin(psi) cos(psi)-sin(psi) cos(psi)+sin(psi)|	F1
// B = Rw/4	|sin(psi)-cos(psi) sin(psi)+cos(psi) sin(psi)+cos(psi) sin(psi)-cos(psi)|	F2
//			|      -1/(L+l)           1/(L+l)          -1/(L+l)           1/(L+l)]	|	F3
// C = |0 0 1|
psiController_matrix3_4_t PsiController_systemMatrix(float psi)
{
	psiController_matrix3_4_t B;
	uint16_t psiToTime;

	if(0 > ((180*psi)/PI))
		psiToTime = (uint16_t)(360 - ((180*psi)/PI));
	else 
		psiToTime = (uint16_t)((180*psi)/PI);

	B.f1c1 = (RW/4)*(psiCos(psiToTime) + psiSin(psiToTime));
	B.f1c2 = (RW/4)*(psiCos(psiToTime) - psiSin(psiToTime));
	B.f1c3 = (RW/4)*(psiCos(psiToTime) - psiSin(psiToTime));
	B.f1c4 = (RW/4)*(psiCos(psiToTime) + psiSin(psiToTime));
	B.f2c1 = (RW/4)*(psiSin(psiToTime) - psiCos(psiToTime));
	B.f2c2 = (RW/4)*(psiSin(psiToTime) + psiCos(psiToTime));
	B.f2c3 = (RW/4)*(psiSin(psiToTime) + psiCos(psiToTime));
	B.f2c4 = (RW/4)*(psiSin(psiToTime) - psiCos(psiToTime));
	B.f3c1 = (RW/4)*(-1/(L+l));
	B.f3c2 = (RW/4)*(1/(L+l));
	B.f3c3 = (RW/4)*(-1/(L+l));
	B.f3c4 = (RW/4)*(1/(L+l));

	return B;
}

psiController_controlLawMatrix_t psiController_controlLaw(float psi, uint16_t time, uint8_t NumberOfSin, uint8_t amplitude)
{
	psiController_controlLawMatrix_t U;
	float e, u;

	e = (amplitude*psiSin(NumberOfSin*time)) - psi;
	u = ((L+l)/RW)*(amplitude*NumberOfSin*psiCos(NumberOfSin*time) - KE*e);

	U.w1 = -u;
	U.w2 = u;
	U.w3 = -u;
	U.w4 = u;

	return U;
}

// 3x4 * 4x1 = 3x1
psiController_states_t psiController_odes(psiController_matrix3_4_t B, psiController_controlLawMatrix_t U)
{
	psiController_states_t nxtState;
	nxtState.x   = (B.f1c1*U.w1) + (B.f1c2*U.w2) + (B.f1c3*U.w3) + (B.f1c1*U.w4);
	nxtState.y   = (B.f2c1*U.w1) + (B.f2c2*U.w2) + (B.f2c3*U.w3) + (B.f2c1*U.w4);
	nxtState.psi = (B.f3c1*U.w1) + (B.f3c2*U.w2) + (B.f3c3*U.w3) + (B.f3c1*U.w4);

	return nxtState;
}
